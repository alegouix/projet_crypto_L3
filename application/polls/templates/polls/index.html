{% load static %}
<head>
    <meta charset="utf-8"/>
</head>

<link rel="stylesheet" href="{% static 'polls/style.css' %}">

<div class="page-container">

    <h2>Message</h2>
    <form id="form" method="POST">
        {% csrf_token %}
        <label for="message">Entrez un message :</label>
        <input type="text" id="message" name="message" placeholder="Tapez ici..." required />
        <button type="submit">Envoyer</button>
    </form>

    <h3>Message découpé en hexadécimal</h3>
    <table>
        <tbody>
           {% with parties_count=parties|length %}
                <tr>
                    {% for part in parties %}
                        <td>{{ part }}</td>
                    {% endfor %}

                    {% if parties_count < 5 %}
                        {% for _ in "12345"|slice:":{{ 5|add:-parties_count }}" %}
                            <td></td>
                        {% endfor %}
                    {% endif %}
                </tr>
            {% endwith %}
        </tbody>
    </table>


    <h3>Clé</h3>
    <table>
        <tbody>
            <tr>
                <td id="key_str">{{ key_str }}</td>
            </tr>
        </tbody>
    </table>
    
    
    <h3>Explications sur l’étape actuelle</h3>
    <div id="explanation" style="border:1px solid #888; padding:1em; border-radius:10px; background:#1e1e1e; color:white;">
        En attente de la première étape...
    </div>
    
    <h3>Matrice</h3>
    <div class="containerCtrlMatrice">
        <div class="qr-explanation"
            style="position:absolute; right:80%; top:50%; width:15%; padding:1em; border-radius:10px; background:#252525; color:white; box-shadow:0 0 10px rgba(0,0,0,0.5);">
            <h3 style="color:#66ccff;">Quarter Round (QR) – principe</h3>
            <p>
                Un *Quarter Round* opère sur 4 mots de 32 bits <b>(a, b, c, d)</b>.
                Il mélange ces mots en utilisant trois types d’opérations :
            </p>
            <ul>
                <li><b>Addition mod 2³² :</b> <code>a = (a + b) mod 2³²</code></li>
                <li><b>XOR :</b> <code>d = d XOR a</code></li>
                <li><b>Rotation gauche :</b> <code>d = ROTL(d, n)</code> (rotation de n bits)</li>
            </ul>
            <p>Ces opérations sont répétées selon la séquence :</p>
            <ol>
                <li><code>a += b; d ^= a; d = ROTL(d,16)</code></li>
                <li><code>c += d; b ^= c; b = ROTL(b,12)</code></li>
                <li><code>a += b; d ^= a; d = ROTL(d,8)</code></li>
                <li><code>c += d; b ^= c; b = ROTL(b,7)</code></li>
            </ol>
            <p style="font-style:italic; color:#aaa;">
                Ce processus assure une diffusion forte : chaque bit de la clé, du compteur ou du nonce influence rapidement
                tout le bloc.
            </p>
        </div>
        <table>
            <tbody>
                <tr>
                    <td id="c1">{{ c1 }}</td>
                    <td id="c2">{{ c2 }}</td>
                    <td id="c3">{{ c3 }}</td>
                    <td id="c4">{{ c4 }}</td>
                </tr>
                <tr>
                    <td id="k1">{{ k1 }}</td>
                    <td id="k2">{{ k2 }}</td>
                    <td id="k3">{{ k3 }}</td>
                    <td id="k4">{{ k4 }}</td>
                </tr>
                <tr>
                    <td id="k5">{{ k5 }}</td>
                    <td id="k6">{{ k6 }}</td>
                    <td id="k7">{{ k7 }}</td>
                    <td id="k8">{{ k8 }}</td>
                </tr>
                <tr>
                    <td id="ct">{{ ct }}</td>
                    <td id="n1">{{ n1 }}</td>
                    <td id="n2">{{ n2 }}</td>
                    <td id="n3">{{ n3 }}</td>
                </tr>
            </tbody>
        </table>
    
        <table>
            <tbody>
                <tr>
                    <td>
                        <form id="form_control_previous" method="POST">
                            {% csrf_token %}
                            <button id="buttonPrevious" type="submit">Étape précédente</button>
                        </form>
                    </td>
                    <td>
                        <form id="form_control_next" method="POST">
                            {% csrf_token %}
                            <button id="buttonNext" type="submit">Prochaine Étape</button>
                        </form>
                    </td>
                    <td>
                        <form id="form_control_reset" method="POST">
                            {% csrf_token %}
                            <button type="submit">Réinitialiser</button>
                        </form>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="play">||></button>
                    </td>
                    <td>
                        <button id="stop">Stop</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3>MAC Généré par Poly1305</h3>
    <table>
        <tbody>
            <tr>
                <td style="word-break: break-all" id="mac">{{ mac }}</td>
            </tr>
        </tbody>
    </table>

    <h3>Résultat</h3>
    <table>
        <tbody>
            <tr>
                <td style="word-break: break-all" id="res">{{ res }}</td>
            </tr>
        </tbody>
    </table>

    <h3>Mesage décrypté</h3>
    <table>
        <tbody>
            <tr>
                <td style="word-break: break-all" id="decrypt">{{ decrypt }}</td>
            </tr>
        </tbody>
    </table>
</div>

<script>

var run = true;


function changeText(data) {
    for (const [key, value] of Object.entries(data)) {
        dom = document.getElementById(key)
        if(dom != null) {
            if(dom.innerHTML != value && !["res", "decrypt", "mac", "key_str"].includes(key) ) {
                dom.style.color = '#ff0066';
            } else {
                dom.style.color = '#ffffff'
            }
            dom.innerHTML = value
        }
    }
}

document.getElementById("form").addEventListener("submit", function(event) {
    event.preventDefault();

    const message = document.getElementById("message").value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ message })
    })
    .then(response => response.json())
    .then(data => {
        const parts = data.parties;
        const tbody = document.querySelector("tbody");

        // Nettoyage du tableau
        tbody.innerHTML = "";

        const row = document.createElement("tr");
        for (let i = 0; i < parts.length; i++) {
            const cell = document.createElement("td");
            cell.textContent = parts[i] || ""; // Vide si pas assez de parties
            row.appendChild(cell);
        }

        tbody.appendChild(row);

        changeText(data)
        updateExplanation(data.tour, data.qr);
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});


document.getElementById("form_control_next").addEventListener("submit", function(event) {
    event.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ "command" : "next" })
    })
    .then(response => response.json())
    .then(data => {
        changeText(data)
        updateExplanation(data.tour, data.qr);
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});

document.getElementById("form_control_previous").addEventListener("submit", function(event) {
    event.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ "command" : "previous" })
    })
    .then(response => response.json())
    .then(data => {
        //console.log(data);
        changeText(data)
        updateExplanation(data.tour, data.qr);
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});

document.getElementById("form_control_reset").addEventListener("submit", function(event) {
    event.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ "command" : "reset" })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        changeText(data)
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});

document.getElementById("play").addEventListener("click", () => {
    run = true;

    const intervalId = setInterval(() => {
        if (run) {
            document.getElementById('buttonNext').click(); 
        } else {
            clearInterval(intervalId); 
        }
    }, 200);
});

document.getElementById("stop").addEventListener("click", () => {
    run = false;
});


const explanations = [
    "Initialisation de la matrice avec les constantes de ChaCha20 et la clé de 256 bits.",
    "QR 1 : Application du premier *Quarter Round* sur la colonne (c1, k1, k5, ct).",
    "QR 2 : *Quarter Round* sur la colonne (c2, k2, k6, n1).",
    "QR 3 : *Quarter Round* sur la colonne (c3, k3, k7, n2).",
    "QR 4 : *Quarter Round* sur la colonne (c4, k4, k8, n3).",
    "QR 5 : *Quarter Round* sur la diagonale (c1, k2, k7, n3).",
    "QR 6 : *Quarter Round* sur la diagonale (c2, k3, k8, ct).",
    "QR 7 : *Quarter Round* sur la diagonale (c3, k4, k5, n1).",
    "QR 8 : *Quarter Round* sur la diagonale (c4, k1, k6, n2).",
    "Fin du tour : les huit *Quarter Rounds* sont terminés — incrément du compteur.",
    "Les 10 tours sont terminés : génération du keystream et chiffrement du bloc.",
];

function updateExplanation(tour, qr) {
    const expDiv = document.getElementById("explanation");

    nqr = qr-1

    if(tour === 0 && qr === 0) {
        expDiv.innerHTML = explanations[0];
    } else if (tour === 10) {
        expDiv.innerHTML = explanations[10];
    } else if (nqr == -1) {
        expDiv.innerHTML = explanations[9];
    } else if (nqr < 8) {
        expDiv.innerHTML = explanations[nqr + 1];
    } 
}

</script>
