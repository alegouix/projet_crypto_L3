{% load static %}
<head>
    <meta charset="utf-8"/>
</head>

<link rel="stylesheet" href="{% static 'polls/style.css' %}">

<div class="page-container">

    <h2>Message</h2>
    <form id="form" method="POST">
        {% csrf_token %}
        <label for="message">Entrez un message :</label>
        <input type="text" id="message" name="message" placeholder="Tapez ici..." required />
        <button type="submit">Envoyer</button>
    </form>

    <h3>Message découpé en hexadécimal</h3>
    <table>
        <tbody>
           {% with parties_count=parties|length %}
                <tr>
                    {% for part in parties %}
                        <td>{{ part }}</td>
                    {% endfor %}

                    {% if parties_count < 5 %}
                        {% for _ in "12345"|slice:":{{ 5|add:-parties_count }}" %}
                            <td></td>
                        {% endfor %}
                    {% endif %}
                </tr>
            {% endwith %}
        </tbody>
    </table>


    <h3>Clé</h3>
    <table>
        <tbody>
            <tr>
                <td id="key_str">{{ key_str }}</td>
            </tr>
        </tbody>
    </table>


    <h3>Matrice</h3>
    <div class="containerCtrlMatrice">
        <table>
            <tbody>
                <tr>
                    <td id="c1">{{ c1 }}</td>
                    <td id="c2">{{ c2 }}</td>
                    <td id="c3">{{ c3 }}</td>
                    <td id="c4">{{ c4 }}</td>
                </tr>
                <tr>
                    <td id="k1">{{ k1 }}</td>
                    <td id="k2">{{ k2 }}</td>
                    <td id="k3">{{ k3 }}</td>
                    <td id="k4">{{ k4 }}</td>
                </tr>
                <tr>
                    <td id="k5">{{ k5 }}</td>
                    <td id="k6">{{ k6 }}</td>
                    <td id="k7">{{ k7 }}</td>
                    <td id="k8">{{ k8 }}</td>
                </tr>
                <tr>
                    <td id="ct">{{ ct }}</td>
                    <td id="n1">{{ n1 }}</td>
                    <td id="n2">{{ n2 }}</td>
                    <td id="n3">{{ n3 }}</td>
                </tr>
            </tbody>
        </table>

        <table>
            <tbody>
                <tr>
                    <td>
                        <form id="form_control_previous" method="POST">
                            {% csrf_token %}
                            <button id="buttonPrevious" type="submit">Étape précédente</button>
                        </form>
                    </td>
                    <td>
                        <form id="form_control_next" method="POST">
                            {% csrf_token %}
                            <button id="buttonNext" type="submit">Prochaine Étape</button>
                        </form>
                    </td>
                    <td>
                        <form id="form_control_reset" method="POST">
                            {% csrf_token %}
                            <button type="submit">Réinitialiser</button>
                        </form>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="play">||></button>
                    </td>
                    <td>
                        <button id="stop">Stop</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3>MAC Généré par Poly1305</h3>
    <table>
        <tbody>
            <tr>
                <td style="word-break: break-all" id="mac">{{ mac }}</td>
            </tr>
        </tbody>
    </table>

    <h3>Résultat</h3>
    <table>
        <tbody>
            <tr>
                <td style="word-break: break-all" id="res">{{ res }}</td>
            </tr>
        </tbody>
    </table>

    <h3>Mesage décrypté</h3>
    <table>
        <tbody>
            <tr>
                <td style="word-break: break-all" id="decrypt">{{ decrypt }}</td>
            </tr>
        </tbody>
    </table>
</div>

<script>

var run = true;

document.getElementById("form").addEventListener("submit", function(event) {
    event.preventDefault();

    const message = document.getElementById("message").value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ message })
    })
    .then(response => response.json())
    .then(data => {
        const parts = data.parties;
        const tbody = document.querySelector("tbody");

        // Nettoyage du tableau
        tbody.innerHTML = "";

        const row = document.createElement("tr");
        for (let i = 0; i < parts.length; i++) {
            const cell = document.createElement("td");
            cell.textContent = parts[i] || ""; // Vide si pas assez de parties
            row.appendChild(cell);
        }

        tbody.appendChild(row);

        for (const [key, value] of Object.entries(data)) {
            dom = document.getElementById(key)
            if(dom != null) {
                dom.innerHTML = value
            }
        }
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});


document.getElementById("form_control_next").addEventListener("submit", function(event) {
    event.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ "command" : "next" })
    })
    .then(response => response.json())
    .then(data => {
        for (const [key, value] of Object.entries(data)) {
            dom = document.getElementById(key)
            if(dom != null) {
                dom.innerHTML = value
            }
        }
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});

document.getElementById("form_control_previous").addEventListener("submit", function(event) {
    event.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ "command" : "previous" })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        for (const [key, value] of Object.entries(data)) {
            dom = document.getElementById(key)
            if(dom != null) {
                dom.innerHTML = value
            }
        }
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});

document.getElementById("form_control_reset").addEventListener("submit", function(event) {
    event.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ "command" : "reset" })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        for (const [key, value] of Object.entries(data)) {
            dom = document.getElementById(key)
            if(dom != null) {
                dom.innerHTML = value
            }
        }
    })
    .catch(error => {
        console.error("Erreur:", error);
    });
});

document.getElementById("play").addEventListener("click", () => {
    run = true;

    const intervalId = setInterval(() => {
        if (run) {
            document.getElementById('buttonNext').click(); 
        } else {
            clearInterval(intervalId); 
        }
    }, 200);
});

document.getElementById("stop").addEventListener("click", () => {
    run = false;
});

</script>
